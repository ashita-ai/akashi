# Cloud deployment: PgBouncer → TimescaleDB Cloud, Redis local, Qdrant Cloud.
#
# Usage:
#   cp docker/env.cloud.example docker/.env.cloud
#   # Edit docker/.env.cloud with your cloud credentials
#   docker compose -f docker/docker-compose.cloud.yml --env-file docker/.env.cloud up -d
#
# No local Postgres or Qdrant — both are managed cloud services.
# PgBouncer is local because the app's dual-connection architecture needs
# transaction-mode pooling for queries (DATABASE_URL) while LISTEN/NOTIFY
# goes direct to TimescaleDB Cloud (NOTIFY_URL).

services:
  pgbouncer:
    image: edoburu/pgbouncer:latest
    container_name: akashi-pgbouncer
    ports:
      - "127.0.0.1:6432:5432"
    environment:
      # Separate vars instead of DATABASE_URL to avoid query-param parsing issues.
      DB_HOST: ${TIMESCALE_HOST}
      DB_PORT: ${TIMESCALE_PORT:-39116}
      DB_USER: ${TIMESCALE_USER:-tsdbadmin}
      DB_PASSWORD: ${TIMESCALE_PASSWORD}
      DB_NAME: ${TIMESCALE_DB:-tsdb}
      POOL_MODE: transaction
      AUTH_TYPE: scram-sha-256
      SERVER_TLS_SSLMODE: require
      MAX_CLIENT_CONN: 1000
      DEFAULT_POOL_SIZE: 50
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h 127.0.0.1 -p 5432"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: akashi-redis
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redisdata:/data
    command: >
      redis-server
        --appendonly yes
        --maxmemory 128mb
        --maxmemory-policy allkeys-lru
        --requirepass ${REDIS_PASSWORD:-akashi}
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-akashi}", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  akashi:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: akashi-server
    ports:
      - "127.0.0.1:8080:8080"
    environment:
      # Database: queries go through local PgBouncer; NOTIFY goes direct to cloud.
      # PgBouncer authenticates clients with the same credentials it parsed from
      # TIMESCALE_URL, so we reuse TIMESCALE_USER/TIMESCALE_PASSWORD here.
      # The database name must also match what PgBouncer was configured with.
      DATABASE_URL: postgres://${TIMESCALE_USER:-tsdbadmin}:${TIMESCALE_PASSWORD}@pgbouncer:5432/${TIMESCALE_DB:-tsdb}?sslmode=disable
      NOTIFY_URL: ${TIMESCALE_URL}
      REDIS_URL: redis://default:${REDIS_PASSWORD:-akashi}@redis:6379/0

      # Core settings.
      AKASHI_PORT: "8080"
      AKASHI_ADMIN_API_KEY: ${AKASHI_ADMIN_API_KEY}
      AKASHI_LOG_LEVEL: ${AKASHI_LOG_LEVEL:-info}

      # Qdrant Cloud for vector search.
      QDRANT_URL: ${QDRANT_URL}
      QDRANT_API_KEY: ${QDRANT_API_KEY}
      QDRANT_COLLECTION: ${QDRANT_COLLECTION:-akashi_decisions}

      # Embedding provider — cloud mode typically uses OpenAI.
      AKASHI_EMBEDDING_PROVIDER: ${AKASHI_EMBEDDING_PROVIDER:-auto}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      AKASHI_EMBEDDING_MODEL: ${AKASHI_EMBEDDING_MODEL:-text-embedding-3-small}
      AKASHI_EMBEDDING_DIMENSIONS: ${AKASHI_EMBEDDING_DIMENSIONS:-1024}

      # Ollama (alternative to OpenAI — only if you have a host-accessible instance).
      OLLAMA_URL: ${OLLAMA_URL:-}
      OLLAMA_MODEL: ${OLLAMA_MODEL:-mxbai-embed-large}

      # Stripe billing (optional).
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_PRO_PRICE_ID: ${STRIPE_PRO_PRICE_ID:-}

      # SMTP (optional).
      AKASHI_SMTP_HOST: ${AKASHI_SMTP_HOST:-}
      AKASHI_SMTP_PORT: ${AKASHI_SMTP_PORT:-587}
      AKASHI_SMTP_USER: ${AKASHI_SMTP_USER:-}
      AKASHI_SMTP_PASSWORD: ${AKASHI_SMTP_PASSWORD:-}
      AKASHI_SMTP_FROM: ${AKASHI_SMTP_FROM:-noreply@akashi.dev}
      AKASHI_BASE_URL: ${AKASHI_BASE_URL:-http://localhost:8080}

      # Observability (optional).
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-akashi}
    depends_on:
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy

volumes:
  redisdata:
